<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NES DM Console (Phase 1.2)</title>
  <style>
    * { box-sizing: border-box; } /* IMPORTANT: fixes “offset/outside” overflow issues */

    body { margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:#0b1220; color:#e7eefc; }
    .wrap {
      display:grid;
      grid-template-columns: 340px minmax(0,1fr) 380px; /* minmax prevents overflow */
      gap:12px; padding:12px; max-width:1500px; margin:0 auto;
    }

    .card { background:#111b31; border:1px solid #223257; border-radius:14px; padding:12px; min-width:0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; min-width:0; }
    .muted { opacity:.75; font-size:13px; }
    .small { font-size:12px; }

    button { background:#2a66ff; color:#fff; border:0; border-radius:12px; padding:10px 12px; font-weight:700; cursor:pointer; }
    button.secondary { background:#24304f; }
    button.danger { background:#b33a3a; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    input, select, textarea {
      width:100%; background:#0b1220; color:#e7eefc;
      border:1px solid #2a3a66; border-radius:10px; padding:10px;
    }
    textarea { min-height:90px; resize:vertical; }

    h2 { margin:0 0 8px 0; font-size:16px; }

    .list { display:flex; flex-direction:column; gap:6px; min-width:0; }
    .item {
      border:1px solid #223257; border-radius:12px; padding:10px;
      display:grid; grid-template-columns: 1fr auto; gap:8px;
      background:#0b1220;
      min-width:0;
    }
    .item.active {
      border-color:#2a66ff;
      box-shadow: 0 0 0 1px rgba(42,102,255,.35), 0 0 18px rgba(42,102,255,.18);
    }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; background:#24304f; display:inline-block; }
    .pill.good { background:#1f6f3f; }
    .pill.warn { background:#7a5a12; }
    .pill.bad { background:#7a1f2a; }
    .pill.activePill { background:#2a66ff; }

    .log { white-space:pre-wrap; line-height:1.45; font-size:14px; }
    .logEntry { border:1px solid #223257; background:#0b1220; border-radius:12px; padding:10px; margin-bottom:8px; }
    .logEntry button { padding:6px 10px; border-radius:10px; font-weight:700; }

    .split {
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr); /* CRITICAL FIX */
      gap:10px;
      align-items:start;
      min-width:0;
    }

    .actions { display:flex; flex-direction:column; gap:8px; min-width:0; }
    .actionBtn { text-align:left; }

    .targets { display:flex; flex-direction:column; gap:6px; min-width:0; }
    .targetRow { display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid #223257; border-radius:10px; background:#0b1220; min-width:0; }

    .grid2 { display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap:10px; align-items:start; min-width:0; }

    .barWrap { height:10px; border-radius:999px; background:#24304f; overflow:hidden; border:1px solid #223257; }
    .barFill { height:100%; width:50%; background:#1f6f3f; }

    .sectionTitle { display:flex; justify-content:space-between; align-items:center; gap:8px; min-width:0; }
    .divider { height:1px; background:#223257; margin:10px 0; opacity:.8; }

    .turnBox {
      border:1px solid #223257; border-radius:12px; padding:10px; background:#0b1220;
      display:flex; flex-direction:column; gap:8px;
      min-width:0;
    }
    .turnRow { display:flex; gap:8px; flex-wrap:wrap; }

    .toggleBtn { background:#24304f; }
    .toggleBtn.on { background:#2a66ff; }

    .initBox {
      border:1px solid #223257; border-radius:12px; padding:10px; background:#0b1220;
      display:flex; flex-direction:column; gap:8px;
      min-width:0;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- LEFT: ROSTER -->
    <div class="card">
      <div class="sectionTitle">
        <h2>Roster</h2>
        <span class="pill" id="systemPill">—</span>
      </div>

      <div class="row">
        <select id="systemSelect">
          <option value="d20">d20 (D&D-like)</option>
          <option value="d6pool">d6 Pool (Shadowrun-like)</option>
        </select>
        <button id="loadSamplesBtn" class="secondary">Load Samples</button>
      </div>

      <div class="divider"></div>

      <div class="split">
        <div class="card" style="margin:0; padding:10px;">
          <div class="sectionTitle">
            <div><b>PCs</b></div>
            <span class="pill" id="pcCount">0</span>
          </div>
          <div id="pcList" class="list" style="margin-top:8px;"></div>
        </div>

        <div class="card" style="margin:0; padding:10px;">
          <div class="sectionTitle">
            <div><b>NPCs</b></div>
            <span class="pill" id="npcCount">0</span>
          </div>
          <div id="npcList" class="list" style="margin-top:8px;"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div>
        <div class="muted">Import/Export (JSON)</div>
        <textarea id="jsonBox" placeholder="Paste character JSON array here..."></textarea>
        <div class="row" style="margin-top:8px;">
          <button id="importBtn" class="secondary">Import</button>
          <button id="exportBtn" class="secondary">Export</button>
          <button id="wipeBtn" class="danger">Wipe Session</button>
        </div>
      </div>
    </div>

    <!-- CENTER: LOG / TIMELINE -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2>Combat Log</h2>
        <div class="row">
          <button id="startEncounterBtn" class="secondary">Start Encounter</button>
          <button id="rollInitBtn" class="secondary">Roll Initiative</button>
          <button id="endTurnBtn" class="secondary">End Turn</button>
          <button id="nextTurnBtn">Next Turn</button>
        </div>
      </div>

      <div class="row muted small" style="justify-content:space-between; margin-bottom:8px;">
        <div>Round: <span id="roundLabel">—</span></div>
        <div>Turn: <span id="turnLabel">—</span></div>
        <div>Active: <span id="activeLabel">—</span></div>
        <div>Status: <span id="turnStatus">—</span></div>
      </div>

      <div class="initBox">
        <div class="sectionTitle">
          <b>Initiative Order</b>
          <span class="pill" id="initHint">auto</span>
        </div>
        <div id="initList" class="muted small">No initiative yet.</div>
      </div>

      <div style="margin-top:10px;" id="log" class="log"></div>
    </div>

    <!-- RIGHT: ACTIVE / ACTIONS / TARGETS -->
    <div class="card">
      <div class="sectionTitle">
        <h2>Active Character</h2>
        <span class="pill" id="activeRolePill">—</span>
      </div>

      <div class="muted" id="activeMeta">No active character.</div>

      <div class="divider"></div>

      <div class="turnBox">
        <div class="sectionTitle">
          <b>Turn Actions</b>
          <span class="pill" id="apPill">—</span>
        </div>
        <div class="turnRow">
          <button id="apMove" class="toggleBtn secondary">Move</button>
          <button id="apAction" class="toggleBtn secondary">Action</button>
          <button id="apBonus" class="toggleBtn secondary">Bonus</button>
          <button id="apReaction" class="toggleBtn secondary">Reaction</button>
        </div>
        <div class="muted small">If a button is OFF, that action type is already spent this turn.</div>
      </div>

      <div style="margin-top:10px;" class="card">
        <div class="sectionTitle">
          <b>Roll Mode</b>
          <select id="rollMode" style="width:auto; min-width:160px;">
            <option value="auto">Auto-roll</option>
            <option value="manual">Manual entry</option>
          </select>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <div class="muted small">Primary roll (total or hits)</div>
            <input id="manualPrimary" placeholder="e.g., 17 (d20) or 4 (hits)" />
          </div>
          <div>
            <div class="muted small">Defense roll (optional)</div>
            <input id="manualDefense" placeholder="e.g., 13 or 2" />
          </div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <b>Actions (from sheet)</b>
        <div id="actions" class="actions" style="margin-top:8px;"></div>
      </div>

      <div style="margin-top:10px;">
        <b>Targets</b>
        <div id="targets" class="targets" style="margin-top:8px;"></div>
      </div>

      <div style="margin-top:10px;" class="card">
        <b>Conditions / Modifiers</b>
        <div class="muted small">Applies to the ACTIVE character</div>
        <div class="grid2" style="margin-top:8px;">
          <select id="advMode">
            <option value="none">Normal</option>
            <option value="adv">Advantage</option>
            <option value="dis">Disadvantage</option>
          </select>
          <input id="rollMod" placeholder="Roll modifier (e.g., +2 or -1)" />
        </div>
        <div style="margin-top:8px;">
          <input id="condNote" placeholder='Add note (e.g., "Bless", "Prone", "-2 Wound")' />
          <div class="row" style="margin-top:8px;">
            <button id="addCondBtn" class="secondary">Add</button>
            <button id="clearCondsBtn" class="secondary">Clear</button>
          </div>
          <div id="condList" class="muted small" style="margin-top:8px;"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="libraryBtn" class="secondary">Roster</button>
      </div>
    </div>

  </div>

  <script src="dm.js"></script>
</body>
</html>
